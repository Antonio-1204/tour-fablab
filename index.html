<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tour FabLab</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <script>
      // =================================================================
      // NUEVO COMPONENTE: LOGO QUE GIRA CON LA C√ÅMARA (Nadir Follow)
      // =================================================================
      AFRAME.registerComponent('rotate-with-camera', {
        tick: function () {
          var camera = this.el.sceneEl.camera; 
          if (!camera) return;
          var camRot = document.querySelector('[camera]').getAttribute('rotation');
          this.el.setAttribute('rotation', {x: 0, y: camRot.y, z: 0});
        }
      });

      // =================================================================
      // COMPONENTE 1: COMPORTAMIENTO VISUAL
      // =================================================================
      AFRAME.registerComponent('hotspot-behavior', {
        init: function () {
          var el = this.el;
          var originalColor = el.getAttribute('color'); 

          el.addEventListener('mouseenter', function () {
            if (originalColor === '#CC0000') {
               el.setAttribute('color', '#FF5555'); 
            }
            
            var tooltip = el.querySelector('.tooltip');
            if(tooltip) tooltip.setAttribute('visible', true);
            
            var bannerText = el.parentNode.querySelector('.banner-text');
            if(bannerText) bannerText.setAttribute('color', '#FFEB3B'); 
          });

          el.addEventListener('mouseleave', function () {
            if (originalColor === '#CC0000') {
               el.setAttribute('color', '#CC0000');
            }

            var tooltip = el.querySelector('.tooltip');
            if(tooltip) tooltip.setAttribute('visible', false);

            var bannerText = el.parentNode.querySelector('.banner-text');
            if(bannerText) bannerText.setAttribute('color', '#FFFFFF');
          });
        }
      });

      // =================================================================
      // COMPONENTE 2: TRANSICI√ìN
      // =================================================================
      AFRAME.registerComponent('transition-to-image', {
        schema: {
          target: {type: 'string', default: ''},
          groupToHide: {type: 'string', default: ''},
          groupToShow: {type: 'string', default: ''},
          rotation: {type: 'vec3', default: {x: 0, y: 0, z: 0}}
        },
        init: function () {
          var el = this.el;
          var data = this.data;
          
          el.addEventListener('click', function () {
            var sky = document.querySelector('a-sky');
            var fadeSphere = document.querySelector('#fade-sphere');
            var cameraRig = document.querySelector('#rig');

            fadeSphere.setAttribute('visible', true);
            fadeSphere.emit('fade-out');

            setTimeout(function() {
              sky.setAttribute('src', data.target);
              
              if(data.groupToHide) document.querySelector(data.groupToHide).setAttribute('visible', false);
              if(data.groupToShow) document.querySelector(data.groupToShow).setAttribute('visible', true);
              
              if(data.rotation) {
                cameraRig.setAttribute('rotation', data.rotation); 
              }

              fadeSphere.emit('fade-in');
              setTimeout(function(){ fadeSphere.setAttribute('visible', false); }, 1000);
            }, 1000); 
          });
        }
      });
    </script>
  </head>
  
  <body>
    <a-scene renderer="colorManagement: true; antialias: true;" cursor="rayOrigin: mouse" raycaster="objects: .clickable"> 

      <a-assets>
        <img id="img-fablab" src="textures/FabLab.jpg">
        <img id="img-entrada" src="textures/FabLab Entrada.jpg"> 
        <img id="img-trabajo" src="textures/FabLab Trabajo.jpg"> 
        <img id="thumb-fablab" src="textures/FabLab.jpg">
        <img id="thumb-entrada" src="textures/FabLab Entrada.jpg">
        <img id="thumb-trabajo" src="textures/FabLab Trabajo.jpg"> 
        <img id="logo-suelo" src="textures/ESAN.png">
      </a-assets>

      <a-entity id="rig" position="0 0 0">
        <a-camera camera position="0 1.6 0" look-controls="pointerLockEnabled: false">
          <a-sphere id="fade-sphere" visible="false" radius="0.1" material="color: black; opacity: 0; shader: flat; side: double; transparent: true" 
            animation__out="property: material.opacity; from: 0; to: 1; dur: 1000; startEvents: fade-out" 
            animation__in="property: material.opacity; from: 1; to: 0; dur: 1000; startEvents: fade-in; delay: 200">
          </a-sphere>
        </a-camera>
        <a-entity laser-controls="hand: left; model: true" raycaster="objects: .clickable; far: 20; lineColor: red; lineOpacity: 0.7"></a-entity>
        <a-entity laser-controls="hand: right; model: true" raycaster="objects: .clickable; far: 20; lineColor: red; lineOpacity: 0.7"></a-entity>
      </a-entity>

      <a-sky src="#img-fablab" rotation="0 -130 0"></a-sky>

      <a-entity rotate-with-camera position="0 0.01 0">
          <a-circle 
            src="#logo-suelo" 
            radius="0.4" 
            position="0 0 0" 
            rotation="-90 0 0"
            material="transparent: true; opacity: 0.9"
            shader="flat">
          </a-circle>
      </a-entity>


      <a-entity id="grupo-fablab" visible="true">

          <a-entity position="-3.95 1.40 -1.08" look-at="[camera]">
              <a-entity position="0 0.28 0">
                  <a-plane color="#000000" opacity="0.8" width="0.9" height="0.22" shader="flat"></a-plane>
                  <a-text class="banner-text" value="Ir a Entrada" font="roboto" align="center" color="#FFFFFF" width="6" wrap-count="30" scale="0.3 0.3 0.3" position="0 0 0.02"></a-text>
              </a-entity>
              <a-entity position="0 0 0" scale="1 1 1">
                  <a-circle color="white" radius="0.16" position="0 0 -0.01" shader="flat"></a-circle>
                  <a-circle src="#thumb-entrada" radius="0.14" position="0 0 0" class="clickable" hotspot-behavior transition-to-image="target: #img-entrada; groupToHide: #grupo-fablab; groupToShow: #grupo-entrada"></a-circle>
                  <a-triangle color="white" vertex-a="0 -0.22 0" vertex-b="-0.05 -0.1 0" vertex-c="0.05 -0.1 0" position="0 0 -0.01" shader="flat"></a-triangle>
              </a-entity>
          </a-entity>
          
          <a-entity position="0.80 1.50 2.25" look-at="[camera]">
              <a-entity position="0 0.22 0">
                  <a-plane color="#000000" opacity="0.8" width="0.6" height="0.15" shader="flat"></a-plane>
                  <a-text class="banner-text" value="Area de Trabajo" font="roboto" align="center" color="#FFFFFF" width="4" wrap-count="30" scale="0.3 0.3 0.3" position="0 0 0.02"></a-text>
              </a-entity>
              <a-entity position="0 0 0" scale="0.7 0.7 0.7">
                  <a-circle color="white" radius="0.16" position="0 0 -0.01" shader="flat"></a-circle>
                  <a-circle src="#thumb-trabajo" radius="0.14" position="0 0 0" class="clickable" hotspot-behavior transition-to-image="target: #img-trabajo; groupToHide: #grupo-fablab; groupToShow: #grupo-trabajo; rotation: 0 -130 0"></a-circle>
                  <a-triangle color="white" vertex-a="0 -0.22 0" vertex-b="-0.05 -0.1 0" vertex-c="0.05 -0.1 0" position="0 0 -0.01" shader="flat"></a-triangle>
              </a-entity>
          </a-entity>

          <a-circle color="#CC0000" radius="0.12" position="-2.80 -0.6 -2.04" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>
          
          <a-circle color="#CC0000" radius="0.12" position="0.75 -0 -3.65" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="3.8 0.2 0.3" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="3.22 0 1.66" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="2.00 -0.2 3.05" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üñ®Ô∏è" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Impresora 3D" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="-0.00 0.5 3.85" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="ü§ñ" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Brazo Robot" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="-1.47 0.1 -3.85" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

          <a-circle color="#CC0000" radius="0.12" position="-0.14 0.7 -3.85" scale="1 1 1" look-at="[camera]" hotspot-behavior class="clickable">
            <a-text value="üíª" align="center" width="2.5" position="0 0 0.05"></a-text><a-ring color="white" radius-inner="0.10" radius-outer="0.12" position="0 0 0.01"></a-ring>
            <a-entity class="tooltip" position="0 0.25 0" visible="false"><a-plane color="#000" opacity="0.8" width="1.0" height="0.3"></a-plane><a-text value="Laptop Dell" align="center" width="2.3" position="0 0 0.02"></a-text></a-entity>
          </a-circle>

      </a-entity> 


      <a-entity id="grupo-entrada" visible="false">
          <a-entity position="-1.30 1.50 -3.50" look-at="[camera]">
              <a-entity position="0 0.28 0">
                  <a-plane color="#000000" opacity="0.8" width="0.9" height="0.22" shader="flat"></a-plane>
                  <a-text class="banner-text" value="Volver al FabLab" font="roboto" align="center" color="#FFFFFF" width="6" wrap-count="30" scale="0.25 0.25 0.25" position="0 0 0.02"></a-text>
              </a-entity>
              <a-entity position="0 0 0" scale="1 1 1">
                  <a-circle color="white" radius="0.16" position="0 0 -0.01" shader="flat"></a-circle>
                  <a-circle src="#thumb-fablab" radius="0.14" position="0 0 0" class="clickable" hotspot-behavior transition-to-image="target: #img-fablab; groupToHide: #grupo-entrada; groupToShow: #grupo-fablab"></a-circle>
                  <a-triangle color="white" vertex-a="0 -0.22 0" vertex-b="-0.05 -0.1 0" vertex-c="0.05 -0.1 0" position="0 0 -0.01" shader="flat"></a-triangle>
              </a-entity>
          </a-entity>
      </a-entity>


      <a-entity id="grupo-trabajo" visible="false">
          <a-entity position="-3.15 1.20 4.00" look-at="[camera]"> 
              <a-entity position="0 0.28 0">
                  <a-plane color="#000000" opacity="0.8" width="0.9" height="0.22" shader="flat"></a-plane>
                  <a-text class="banner-text" value="Volver al FabLab" font="roboto" align="center" color="#FFFFFF" width="6" wrap-count="30" scale="0.25 0.25 0.25" position="0 0 0.02"></a-text>
              </a-entity>
              <a-entity position="0 0 0" scale="1 1 1">
                  <a-circle color="white" radius="0.16" position="0 0 -0.01" shader="flat"></a-circle>
                  <a-circle src="#thumb-fablab" radius="0.14" position="0 0 0" class="clickable" hotspot-behavior transition-to-image="target: #img-fablab; groupToHide: #grupo-trabajo; groupToShow: #grupo-fablab"></a-circle>
                  <a-triangle color="white" vertex-a="0 -0.22 0" vertex-b="-0.05 -0.1 0" vertex-c="0.05 -0.1 0" position="0 0 -0.01" shader="flat"></a-triangle>
              </a-entity>
          </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>

